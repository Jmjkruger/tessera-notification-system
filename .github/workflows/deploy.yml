name: Deploy TNS to Lightsail

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script_stop: true
          script: |
            bash -l -c '
              set -e

              TNS_DIR=~/tessera-notification-system

              # First deploy: clone if .git does not exist (directory may exist with just .env)
              if [ ! -d "$TNS_DIR/.git" ]; then
                echo "First deploy â€” cloning repository..."
                # Preserve .env if it exists
                if [ -f "$TNS_DIR/.env" ]; then
                  cp "$TNS_DIR/.env" /tmp/tns-env-backup
                fi
                rm -rf "$TNS_DIR"
                git clone https://github.com/Jmjkruger/tessera-notification-system.git "$TNS_DIR"
                if [ -f /tmp/tns-env-backup ]; then
                  mv /tmp/tns-env-backup "$TNS_DIR/.env"
                fi
              fi

              cd "$TNS_DIR"

              echo "Pulling latest code..."
              git fetch origin main
              git reset --hard origin/main

              echo "Installing dependencies..."
              npm ci --omit=dev

              echo "Restarting TNS..."
              pm2 describe tessera-tns > /dev/null 2>&1 && pm2 restart tessera-tns || pm2 start ecosystem.config.js
              pm2 save

              echo "============================"
              echo "   TNS DEPLOY SUCCESS       "
              echo "============================"
              echo "Version: $(node -p "require(\"./package.json\").version")"
              echo "Time: $(date)"
              echo "============================"
            '
